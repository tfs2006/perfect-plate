# JavaScript Directory - Copilot Instructions

## Purpose
This directory contains the frontend JavaScript code for the Perfect-Plate application.

## File Structure
- `config.js` - API endpoint configuration
- `script.js` - Main application logic (single-file architecture)

## Coding Guidelines

### General Principles
- **No Build Tools**: All code must run directly in modern browsers without transpilation
- **ES6+ Only**: Use modern JavaScript features (browser compatibility: Chrome 90+, Firefox 88+, Safari 14+)
- **IIFE Wrapper**: All code must be wrapped in an immediately invoked function expression to avoid polluting global namespace
- **Strict Mode**: Implicit via ES6 modules pattern

### Code Organization in script.js
The file follows this structure:
1. **Utilities Section** (top)
   - DOM helpers
   - Formatting functions
   - String manipulation utilities
2. **State Management**
   - Form state in localStorage
   - Current meal plan data
3. **Form Handling**
   - Multi-step form navigation
   - Input validation
   - State persistence
4. **API Communication**
   - Async fetch calls through proxy
5. **UI Rendering**
   - Results display
   - Grocery list generation
   - PDF export
6. **Event Listeners** (bottom)
   - Registered in DOMContentLoaded or ready() callback

### Utility Functions
Always use these standard utilities:

```javascript
// DOM selection
const $ = (id) => document.getElementById(id);

// HTML escaping for security
const escapeHTML = (s) => String(s).replace(/[&<>\"']/g, c => ({
  "&": "&amp;",
  "<": "&lt;",
  ">": "&gt;",
  "\"": "&quot;",
  "'": "&#39;"
}[c]));

// Icon initialization
const initIcons = () => { 
  if (window.lucide?.createIcons) { 
    try { window.lucide.createIcons(); } catch {} 
  } 
};
```

### Error Handling
- Always wrap async operations in try-catch blocks
- Provide user-friendly error messages
- Log detailed errors to console for debugging
- Check for null/undefined before accessing properties using optional chaining

```javascript
try {
  const response = await fetch(url);
  const data = await response.json();
  // Process data
} catch (err) {
  console.error("Error details:", err);
  showMessage("Something went wrong. Please try again.", true);
}
```

### API Calls
All API calls must go through the Netlify Functions proxy:

```javascript
const response = await fetch(`${window.API_BASE}/generate-plan`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ 
    endpoint: "gemini-1.5-flash:generateContent",
    body: { contents: [...] }
  })
});
```

### State Persistence
Use localStorage for form state:

```javascript
// Save with debouncing (300ms)
const saveFormState = debounce(() => {
  try {
    const state = { age, gender, ethnicity, ... };
    localStorage.setItem("formState", JSON.stringify(state));
  } catch (err) {
    console.warn("Could not save form state:", err);
  }
}, 300);
```

### DOM Manipulation
- Use `textContent` instead of `innerHTML` for user-generated content
- Always check elements exist before manipulating
- Batch DOM updates when possible
- Call `initIcons()` after adding new content with icons

```javascript
const element = $("my-element");
if (element) {
  element.textContent = escapeHTML(userInput);
}
```

### Performance Patterns
- **Debouncing**: Use for frequent events (input, resize)
- **Caching**: Store DOM references in function scope
- **Event Delegation**: For dynamic content
- **Lazy Loading**: Load heavy libraries only when needed

### Security Requirements
1. **Always escape user input** before rendering
2. **Never use eval()** or similar dynamic code execution
3. **Validate data** from localStorage (may be tampered)
4. **Use textContent** for inserting user-generated text
5. **Check API responses** for malicious content

### Async Patterns
Prefer async/await over promises:

```javascript
// Good
async function loadData() {
  const data = await fetchData();
  return processData(data);
}

// Avoid
function loadData() {
  return fetchData().then(data => processData(data));
}
```

### Common Patterns

#### Form Navigation
```javascript
function goToStep(n) {
  document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
  $(`step-${n}`)?.classList.add('active');
  updateStepIndicators(n);
}
```

#### Show/Hide Loader
```javascript
function showLoader(show = true) {
  const loader = $("loader");
  if (loader) {
    loader.style.display = show ? "flex" : "none";
  }
}
```

#### Message Display
```javascript
function showMessage(text, isError = false) {
  const box = $("message-box");
  const msgText = $("message-text");
  if (box && msgText) {
    msgText.textContent = text;
    box.classList.remove("hidden");
    if (isError) box.classList.add("error");
    setTimeout(() => box.classList.add("hidden"), 4000);
  }
}
```

## config.js Specifics
- Contains only one line: `window.API_BASE = "<netlify-function-url>"`
- Must be loaded before script.js
- Change this value when deploying to different environments

## Testing Checklist
When modifying JavaScript:
- [ ] Test in Chrome, Firefox, Safari
- [ ] Test on mobile devices
- [ ] Verify no console errors
- [ ] Check form validation works
- [ ] Test error scenarios (network failures, invalid input)
- [ ] Verify localStorage persistence
- [ ] Test PDF export (if modified)
- [ ] Ensure icons render properly

## Browser Compatibility
Target modern browsers:
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+
- iOS Safari 14+
- Chrome Android 90+

Features used that require modern browsers:
- Optional chaining (`?.`)
- Nullish coalescing (`??`)
- `async`/`await`
- ES6 modules pattern
- CSS `:has()` selector (with fallback)

## Anti-Patterns to Avoid
- ❌ Global variables (use IIFE scope)
- ❌ Inline event handlers in HTML
- ❌ `innerHTML` for user content
- ❌ Synchronous XHR
- ❌ Deep nesting (max 3 levels)
- ❌ Large functions (>100 lines)
- ❌ Magic numbers (use named constants)

## Maintenance Notes
- Keep script.js under 2000 lines
- Extract complex algorithms to separate utility functions
- Document any workarounds for browser bugs
- Update TESTING_SUMMARY.md after significant changes
