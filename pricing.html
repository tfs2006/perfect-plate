<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing - Perfect Plate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto py-12">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold text-white mb-4">Choose Your Plan</h1>
            <p class="text-xl text-purple-100">Get more meal generations and unlock unlimited features</p>
        </div>

        <!-- User Info Bar -->
        <div class="bg-white rounded-lg p-4 mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 max-w-2xl mx-auto">
            <a href="/profile.html" class="flex items-center gap-3 hover:bg-gray-50 p-2 rounded-lg transition duration-200 -m-2 flex-1">
                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <i data-lucide="user" class="w-5 h-5 text-white"></i>
                </div>
                <div class="flex-1">
                    <p id="userName" class="font-semibold text-gray-800">Loading...</p>
                    <p id="currentPlan" class="text-sm text-gray-600">Loading plan...</p>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 hidden sm:block"></i>
            </a>
            <div class="text-left sm:text-right w-full sm:w-auto">
                <p class="text-sm text-gray-600">This month:</p>
                <p id="generationCount" class="font-bold text-purple-600">Loading...</p>
            </div>
        </div>

        <!-- Pricing Cards -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 max-w-6xl mx-auto mb-8">
            <!-- Starter Plan -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 transform hover:scale-105 transition duration-300">
                <div class="text-center mb-6">
                    <div class="inline-block p-3 bg-blue-100 rounded-full mb-4">
                        <i data-lucide="zap" class="w-8 h-8 text-blue-600"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Starter</h3>
                    <div class="flex items-baseline justify-center gap-2">
                        <span class="text-5xl font-bold text-gray-800">$4.99</span>
                        <span class="text-gray-600">/month</span>
                    </div>
                </div>
                <ul class="space-y-4 mb-8">
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700"><strong>30 generations</strong> per month</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Full meal plans with macros</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Shopping list generator</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Save favorite meals</span>
                    </li>
                </ul>
                <button onclick="selectPlan('starter', 'price_starter_4_99')" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-300">
                    Get Started
                </button>
            </div>

            <!-- Pro Plan (Most Popular) -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 transform scale-105 border-4 border-purple-500 relative">
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-purple-500 text-white px-4 py-1 rounded-full text-sm font-bold">
                    MOST POPULAR
                </div>
                <div class="text-center mb-6">
                    <div class="inline-block p-3 bg-purple-100 rounded-full mb-4">
                        <i data-lucide="star" class="w-8 h-8 text-purple-600"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Pro</h3>
                    <div class="flex items-baseline justify-center gap-2">
                        <span class="text-5xl font-bold text-gray-800">$9.99</span>
                        <span class="text-gray-600">/month</span>
                    </div>
                </div>
                <ul class="space-y-4 mb-8">
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700"><strong>100 generations</strong> per month</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Everything in Starter</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Priority support</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Advanced customization</span>
                    </li>
                </ul>
                <button onclick="selectPlan('pro', 'price_pro_9_99')" 
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-300">
                    Upgrade to Pro
                </button>
            </div>

            <!-- Unlimited Plan -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 transform hover:scale-105 transition duration-300">
                <div class="text-center mb-6">
                    <div class="inline-block p-3 bg-gradient-to-r from-purple-100 to-pink-100 rounded-full mb-4">
                        <i data-lucide="crown" class="w-8 h-8 text-purple-600"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Unlimited</h3>
                    <div class="flex items-baseline justify-center gap-2">
                        <span class="text-5xl font-bold text-gray-800">$19.99</span>
                        <span class="text-gray-600">/month</span>
                    </div>
                </div>
                <ul class="space-y-4 mb-8">
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700"><strong>Unlimited generations</strong> ‚ôæÔ∏è</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Everything in Pro</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">VIP support</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="check" class="w-5 h-5 text-green-500 mt-1 flex-shrink-0"></i>
                        <span class="text-gray-700">Early access to features</span>
                    </li>
                </ul>
                <button onclick="selectPlan('unlimited', 'price_unlimited_19_99')" 
                    class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white font-semibold py-3 rounded-lg transition duration-300">
                    Go Unlimited
                </button>
            </div>
        </div>

        <!-- Back to App -->
        <div class="text-center">
            <a href="index.html" class="inline-flex items-center gap-2 text-white hover:text-purple-100 transition duration-200">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                Back to Meal Planner
            </a>
        </div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Load user info
        async function loadUserInfo() {
            const session = await checkAuth();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const profile = await getUserProfile();
            if (profile) {
                document.getElementById('userName').textContent = profile.full_name || 'User';
                
                // Display current plan
                const planNames = {
                    3: 'Free Plan (3/month)',
                    30: 'Starter Plan (30/month)',
                    100: 'Pro Plan (100/month)',
                    '-1': 'Unlimited Plan'
                };
                const planName = planNames[profile.monthly_generation_limit] || 'Free Plan';
                document.getElementById('currentPlan').textContent = planName;
            }

            const remaining = await getRemainingGenerations();
            const displayEl = document.getElementById('generationCount');
            if (remaining === -1) {
                displayEl.textContent = '‚ôæÔ∏è Unlimited';
            } else {
                displayEl.textContent = `${remaining} remaining`;
            }
        }

        // Select plan and create checkout session
        async function selectPlan(planName, priceId) {
            try {
                console.log('üõí Creating checkout session for:', planName, priceId);
                
                const profile = await getUserProfile();
                if (!profile) {
                    alert('Please sign in first');
                    window.location.href = 'login.html';
                    return;
                }

                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Loading...';
                button.disabled = true;

                // Create checkout session
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId: priceId,
                        customerEmail: profile.email,
                        userId: profile.id,
                        successUrl: `${window.location.origin}/index.html?session_id={CHECKOUT_SESSION_ID}`,
                        cancelUrl: `${window.location.origin}/pricing.html`
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create checkout session');
                }

                const { url } = await response.json();
                
                // Redirect to Stripe Checkout
                console.log('‚úÖ Redirecting to Stripe Checkout:', url);
                window.location.href = url;
                
            } catch (error) {
                console.error('‚ùå Error selecting plan:', error);
                alert('Error: ' + error.message);
                // Restore button state
                if (event && event.target) {
                    event.target.textContent = originalText;
                    event.target.disabled = false;
                }
            }
        }

        // Load on page load
        loadUserInfo();
    </script>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 py-8 mt-16">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8 mb-6">
                <!-- About -->
                <div>
                    <h3 class="text-white font-bold mb-3">Perfect Plate</h3>
                    <p class="text-sm">Intelligent nutrition, simplified. AI-powered meal planning for a healthier you.</p>
                </div>
                
                <!-- Legal Links -->
                <div>
                    <h3 class="text-white font-bold mb-3">Legal</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="/terms.html" class="hover:text-purple-400 transition">Terms of Service</a></li>
                        <li><a href="/privacy.html" class="hover:text-purple-400 transition">Privacy Policy</a></li>
                    </ul>
                </div>
                
                <!-- Contact -->
                <div>
                    <h3 class="text-white font-bold mb-3">Contact</h3>
                    <p class="text-sm">Questions or feedback?</p>
                    <a href="mailto:perfectplate@4ourmedia.com" class="text-purple-400 hover:text-purple-300 transition text-sm">perfectplate@4ourmedia.com</a>
                </div>
            </div>
            
            <div class="border-t border-gray-800 pt-6 text-center text-sm">
                <p>&copy; <span id="currentYear"></span> Perfect Plate. All rights reserved.</p>
                <p class="mt-2">A <a href="https://4ourmedia.com" target="_blank" class="text-purple-400 hover:text-purple-300 transition">4ourmedia</a> App by David J Woodbury</p>
            </div>
        </div>
    </footer>

    <script>
        // Auto-update copyright year
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>
